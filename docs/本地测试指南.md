# æœ¬åœ°æµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¶æ„è¯´æ˜

### æ•°æ®æ¨¡å‹ï¼ˆé‡æ„åï¼‰
æœ¬ç³»ç»Ÿé‡‡ç”¨**ä¸€ä¸ªç”¨æˆ·ä¸€æ¡è®°å½•**çš„è®¾è®¡ï¼š
- `user_tags.tag_ids`: JSONæ•°ç»„ï¼Œå­˜å‚¨ç”¨æˆ·çš„æ‰€æœ‰æ ‡ç­¾ID `[1,2,3,5]`
- `user_tags.tag_details`: JSONå¯¹è±¡ï¼Œå­˜å‚¨æ ‡ç­¾è¯¦ç»†ä¿¡æ¯
- **ä¼˜åŠ¿**: çœŸæ­£çš„æ ‡ç­¾åˆå¹¶ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚

### æ ‡ç­¾åˆå¹¶é€»è¾‘
- æ–°è®¡ç®—æ ‡ç­¾ + å·²æœ‰æ ‡ç­¾ â†’ æ•°ç»„åˆå¹¶å»é‡
- æ”¯æŒå¢é‡æ›´æ–°ï¼Œå†å²æ ‡ç­¾ä¿ç•™
- MySQL JSONç±»å‹æ”¯æŒé«˜æ•ˆæŸ¥è¯¢

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒéƒ¨ç½²
```bash
cd environments/local
./setup.sh
```

### 2. å¥åº·æ£€æŸ¥
```bash
python main.py --env local --mode health
```

## æ ‡ç­¾è®¡ç®—æµ‹è¯•

### å…¨é‡æ ‡ç­¾è®¡ç®—
```bash
python main.py --env local --mode full
```

### å¢é‡æ ‡ç­¾è®¡ç®—
```bash
python main.py --env local --mode incremental --days 3
```

### æŒ‡å®šæ ‡ç­¾è®¡ç®—
```bash
python main.py --env local --mode tags --tag-ids 1,3,5
```

## å•å…ƒæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python -m pytest tests/ -v

# è¿è¡Œå•å…ƒæµ‹è¯•
python -m pytest tests/unit/ -v

# è¿è¡Œé›†æˆæµ‹è¯•
python -m pytest tests/integration/ -v
```

## æŸ¥çœ‹ç»“æœ

### æŸ¥çœ‹æ ‡ç­¾è®¡ç®—ç»“æœï¼ˆæ–°æ•°æ®æ¨¡å‹ï¼šä¸€ä¸ªç”¨æˆ·ä¸€æ¡è®°å½•ï¼‰
```bash
# æŸ¥çœ‹ç”¨æˆ·æ ‡ç­¾è®°å½•æ€»æ•°
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT COUNT(*) as total_users FROM user_tags;"

# æŸ¥çœ‹ç”¨æˆ·æ ‡ç­¾æ¦‚è§ˆï¼ˆæ˜¾ç¤ºæ¯ä¸ªç”¨æˆ·çš„æ ‡ç­¾æ•°é‡ï¼‰
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT user_id, JSON_LENGTH(tag_ids) as tag_count, computed_date FROM user_tags LIMIT 10;"

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æ ‡ç­¾è¯¦æƒ…
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT user_id, JSON_PRETTY(tag_ids) as user_tags, JSON_PRETTY(tag_details) as tag_info FROM user_tags WHERE user_id='user_000001';"

# æŸ¥çœ‹æ ‡ç­¾åˆ†å¸ƒç»Ÿè®¡
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT JSON_LENGTH(tag_ids) as tags_per_user, COUNT(*) as user_count FROM user_tags GROUP BY JSON_LENGTH(tag_ids) ORDER BY tags_per_user;"

# æŸ¥è¯¢å…·æœ‰ç‰¹å®šæ ‡ç­¾çš„ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šæ ‡ç­¾IDä¸º1çš„ç”¨æˆ·ï¼‰
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT user_id, JSON_PRETTY(tag_ids) as tags FROM user_tags WHERE JSON_CONTAINS(tag_ids, '1');"

# æŸ¥è¯¢å…·æœ‰å¤šä¸ªæ ‡ç­¾çš„ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šåŒæ—¶å…·æœ‰æ ‡ç­¾1å’Œ2çš„ç”¨æˆ·ï¼‰
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT user_id, JSON_PRETTY(tag_ids) as tags FROM user_tags WHERE JSON_CONTAINS(tag_ids, '1') AND JSON_CONTAINS(tag_ids, '2');"
```

### æŸ¥çœ‹æ ‡ç­¾è§„åˆ™
```bash
# æŸ¥çœ‹æ´»è·ƒæ ‡ç­¾è§„åˆ™
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT tr.rule_id, td.tag_name, td.tag_category, tr.is_active FROM tag_rules tr JOIN tag_definition td ON tr.tag_id = td.tag_id WHERE tr.is_active = 1;"

# æŸ¥çœ‹å…·ä½“è§„åˆ™æ¡ä»¶
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT rule_id, tag_id, JSON_PRETTY(rule_conditions) as rule_conditions FROM tag_rules WHERE is_active = 1;"

# æŸ¥çœ‹æ ‡ç­¾å®šä¹‰
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "USE tag_system; SELECT tag_id, tag_name, tag_category, description FROM tag_definition ORDER BY tag_id;"
```

### éªŒè¯æ ‡ç­¾è®¡ç®—æ­£ç¡®æ€§
```bash
# æ£€æŸ¥æ ‡ç­¾è®¡ç®—ç»“æœï¼ˆæ–°æ•°æ®æ¨¡å‹éªŒè¯ï¼‰
python -c "
from src.config.manager import ConfigManager
config = ConfigManager.load_config('local')
from pyspark.sql import SparkSession
from pyspark.sql.functions import from_json, size, explode
from pyspark.sql.types import ArrayType, IntegerType

spark = SparkSession.builder.master('local[*]').appName('DataCheck').getOrCreate()
try:
    # è¯»å–ç”¨æˆ·æ ‡ç­¾æ•°æ®
    df = spark.read.jdbc(url=config.mysql.jdbc_url, table='user_tags', properties=config.mysql.connection_properties)
    print(f'âœ… ç”¨æˆ·æ ‡ç­¾è®°å½•æ•°ï¼ˆç”¨æˆ·æ•°ï¼‰: {df.count()}')
    
    # è§£æJSONæ•°ç»„å¹¶ç»Ÿè®¡
    parsed_df = df.select(
        'user_id',
        from_json('tag_ids', ArrayType(IntegerType())).alias('tag_ids_array')
    )
    
    # ç»Ÿè®¡æ ‡ç­¾åˆ†å¸ƒ
    tag_stats = parsed_df.select('user_id', size('tag_ids_array').alias('tag_count'))
    print('\\nğŸ“Š ç”¨æˆ·æ ‡ç­¾æ•°é‡åˆ†å¸ƒ:')
    tag_stats.groupBy('tag_count').count().orderBy('tag_count').show()
    
    # ç»Ÿè®¡æ€»æ ‡ç­¾åˆ†é…æ•°
    total_assignments = tag_stats.agg({'tag_count': 'sum'}).collect()[0][0]
    print(f'ğŸ“ˆ æ€»æ ‡ç­¾åˆ†é…æ•°: {total_assignments}')
    
    # å±•å¼€æ‰€æœ‰æ ‡ç­¾å¹¶ç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„ç”¨æˆ·æ•°
    all_tags = parsed_df.select('user_id', explode('tag_ids_array').alias('tag_id'))
    print('\\nğŸ·ï¸  å„æ ‡ç­¾çš„ç”¨æˆ·åˆ†å¸ƒ:')
    all_tags.groupBy('tag_id').count().orderBy('tag_id').show()
    
finally:
    spark.stop()
"
```

### æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
```bash
# Dockerå®¹å™¨çŠ¶æ€
docker ps

# è®¿é—®Jupyter Lab (å¯é€‰)
# http://localhost:8888

# è®¿é—®MinIOæ§åˆ¶å° (å¯é€‰)
# http://localhost:9001 (minioadmin/minioadmin)
```

## å¸¸è§é—®é¢˜

### ç¯å¢ƒå¯åŠ¨é—®é¢˜
```bash
# æ£€æŸ¥DockerçŠ¶æ€
docker ps

# ç¯å¢ƒç®¡ç†å‘½ä»¤
cd environments/local
./setup.sh setup   # å®Œæ•´éƒ¨ç½²
./setup.sh start   # å¯åŠ¨æœåŠ¡
./setup.sh stop    # åœæ­¢æœåŠ¡  
./setup.sh clean   # æ¸…ç†ç¯å¢ƒ
./setup.sh info    # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
```

### è¿æ¥é—®é¢˜
```bash
# æµ‹è¯•MySQLè¿æ¥
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "SELECT 1;"

# æµ‹è¯•MinIOè¿æ¥
curl http://localhost:9000/minio/health/live
```

### æ ‡ç­¾è®¡ç®—é—®é¢˜

#### å¦‚æœæ ‡ç­¾è®¡ç®—æ˜¾ç¤º"ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
1. **æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ¹é…æ ‡ç­¾è§„åˆ™**:
```bash
# æŸ¥çœ‹ç”Ÿæˆçš„æµ‹è¯•æ•°æ®åˆ†å¸ƒ
python -c "
from src.config.manager import ConfigManager
config = ConfigManager.load_config('local')
from pyspark.sql import SparkSession
spark = SparkSession.builder.master('local[*]').appName('DataCheck').getOrCreate()
try:
    # æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆï¼ˆç”¨äºéªŒè¯ï¼‰
    from src.scheduler.main_scheduler import TagComputeScheduler
    scheduler = TagComputeScheduler(config)
    scheduler.spark = spark
    test_data = scheduler._generate_production_like_data()
    print('æ•°æ®æ ·æœ¬:')
    test_data.show(5)
    print('é«˜å‡€å€¼ç”¨æˆ·æ•°ï¼ˆæ€»èµ„äº§>=100000ï¼‰:')
    print(test_data.filter(test_data.total_asset_value >= 100000).count())
finally:
    spark.stop()
"
```

2. **æ£€æŸ¥æ ‡ç­¾è§„åˆ™æ˜¯å¦æ­£ç¡®**:
```bash
# æŸ¥çœ‹æ´»è·ƒçš„æ ‡ç­¾è§„åˆ™
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "
USE tag_system; 
SELECT rule_id, tag_id, JSON_PRETTY(rule_conditions) as conditions 
FROM tag_rules WHERE is_active = 1;"
```

3. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:
```bash
# è¿è¡Œæ—¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
python main.py --env local --mode full --log-level DEBUG
```

#### å¦‚æœæ²¡æœ‰æ ‡ç­¾ç»“æœ
- æ£€æŸ¥æµ‹è¯•æ•°æ®æ˜¯å¦ç¬¦åˆæ ‡ç­¾è§„åˆ™æ¡ä»¶
- ç¡®è®¤æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®
- æŸ¥çœ‹Sparkè®¡ç®—æ—¥å¿—æ’æŸ¥é—®é¢˜

#### æ€§èƒ½é—®é¢˜
- æœ¬åœ°ç¯å¢ƒèµ„æºæœ‰é™ï¼Œå¤§æ•°æ®é‡æµ‹è¯•å»ºè®®è°ƒæ•´æ•°æ®ç”Ÿæˆè§„æ¨¡
- æ£€æŸ¥Dockerå®¹å™¨èµ„æºåˆ†é…
- è€ƒè™‘è°ƒæ•´Sparké…ç½®å‚æ•°

## ğŸ“Š æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ

### JSONæŸ¥è¯¢æŠ€å·§
```sql
-- æŸ¥è¯¢å…·æœ‰ç‰¹å®šæ ‡ç­¾çš„ç”¨æˆ·
SELECT user_id FROM user_tags WHERE JSON_CONTAINS(tag_ids, '1');

-- æŸ¥è¯¢å…·æœ‰å¤šä¸ªæ ‡ç­¾çš„ç”¨æˆ·ï¼ˆANDå…³ç³»ï¼‰
SELECT user_id FROM user_tags 
WHERE JSON_CONTAINS(tag_ids, '1') AND JSON_CONTAINS(tag_ids, '2');

-- æŸ¥è¯¢å…·æœ‰ä»»ä¸€æ ‡ç­¾çš„ç”¨æˆ·ï¼ˆORå…³ç³»ï¼‰
SELECT user_id FROM user_tags 
WHERE JSON_CONTAINS(tag_ids, '1') OR JSON_CONTAINS(tag_ids, '2');

-- ç»Ÿè®¡æ ‡ç­¾åˆ†å¸ƒ
SELECT JSON_LENGTH(tag_ids) as tag_count, COUNT(*) as user_count 
FROM user_tags GROUP BY JSON_LENGTH(tag_ids);

-- æå–æ ‡ç­¾è¯¦æƒ…
SELECT user_id, 
       JSON_EXTRACT(tag_details, '$.1.tag_name') as tag_1_name
FROM user_tags WHERE JSON_CONTAINS(tag_ids, '1');
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨JSONæŸ¥è¯¢åˆ›å»ºè™šæ‹Ÿåˆ—ç´¢å¼•
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨`JSON_CONTAINS`æ¯”`JSON_EXTRACT`æ›´é«˜æ•ˆ
3. **æ•°æ®åˆ†åŒº**: ç”Ÿäº§ç¯å¢ƒå¯æŒ‰`computed_date`åˆ†åŒº

### æ ‡ç­¾åˆå¹¶éªŒè¯
```bash
# éªŒè¯æ ‡ç­¾åˆå¹¶æ˜¯å¦æ­£ç¡®ï¼ˆè¿è¡Œä¸¤æ¬¡fullæ¨¡å¼ï¼‰
python main.py --env local --mode full
sleep 5
python main.py --env local --mode full

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤æ ‡ç­¾
mysql -h 127.0.0.1 -P 3307 -u root -proot123 -e "
USE tag_system;
SELECT user_id, tag_ids, 
       JSON_LENGTH(tag_ids) as array_length,
       (SELECT COUNT(*) FROM JSON_TABLE(tag_ids, '$[*]' COLUMNS (tag_id INT PATH '$')) as jt) as distinct_count
FROM user_tags 
HAVING array_length != distinct_count;"
```

## æœåŠ¡è®¿é—®
- **MySQLæ•°æ®åº“**: localhost:3307 (root/root123)
- **MinIO Console**: http://localhost:9001 (minioadmin/minioadmin)  
- **MinIO API**: http://localhost:9000 (minioadmin/minioadmin)
- **Spark Master UI**: http://localhost:8080
- **Jupyter Lab**: http://localhost:8888 (token: tag_system_2024)