# ğŸ¬ æµ·è±šè°ƒåº¦å™¨å›¾å½¢ç•Œé¢éƒ¨ç½²è¯´æ˜

## ğŸ“¦ éƒ¨ç½²åŒ…å†…å®¹ï¼ˆç»Ÿä¸€æ¶æ„ç‰ˆï¼‰
- `main.py` - ä¸»ç¨‹åºå…¥å£ï¼ˆç»Ÿä¸€wrapperï¼Œè°ƒç”¨src/tag_engine/main.pyï¼‰
- `src/` - é¡¹ç›®æºç ï¼ˆPySpark DSL + UDFæ¶æ„ï¼‰  
- `generate_test_data.py` - æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
- `create_test_tables.sql` - æµ‹è¯•è¡¨åˆ›å»ºSQL
- `requirements.txt` - Pythonä¾èµ–

## ğŸ—ï¸ æ¶æ„è¯´æ˜
- **æ ¸å¿ƒå…¥å£**: `src/tag_engine/main.py` - å®Œæ•´çš„æ ‡ç­¾è®¡ç®—å¼•æ“
- **éƒ¨ç½²å…¥å£**: `main.py` - ç®€å•wrapperï¼Œç»Ÿä¸€è°ƒç”¨æ ¸å¿ƒå…¥å£
- **æ¶ˆé™¤é‡å¤**: æ‰€æœ‰å…¥å£éƒ½ç»Ÿä¸€è°ƒç”¨æ ¸å¿ƒmain.pyï¼Œé¿å…ä»£ç é‡å¤

## ğŸš€ UIç•Œé¢éƒ¨ç½²æ­¥éª¤ï¼ˆæ¨èï¼‰

### 1. ä¸Šä¼ ZIPåŒ…åˆ°èµ„æºä¸­å¿ƒ
1. ç™»å½•æµ·è±šè°ƒåº¦å™¨Webç•Œé¢
2. è¿›å…¥ **èµ„æºä¸­å¿ƒ** â†’ **æ–‡ä»¶ç®¡ç†**
3. ä¸Šä¼  `tag_system_dolphin.zip`

### 2. åˆ›å»ºShellä»»åŠ¡ - è§£å‹éƒ¨ç½²åŒ…
åˆ›å»ºShellä»»åŠ¡æ¥è§£å‹éƒ¨ç½²åŒ…ï¼š

**ä»»åŠ¡åç§°**: `unzip_deploy_package`
**ä»»åŠ¡ç±»å‹**: Shell
**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/
unzip -o tag_system_dolphin.zip -d bigdata_tag_system/
echo "âœ… éƒ¨ç½²åŒ…è§£å‹å®Œæˆåˆ°: /dolphinscheduler/default/resources/bigdata_tag_system/"
ls -la bigdata_tag_system/main.py bigdata_tag_system/src/ bigdata_tag_system/requirements.txt

```

### 3. åˆ›å»ºShellä»»åŠ¡ - æ–‡ä»¶æƒé™ä¿®å¤
åˆ›å»ºç¬¬äºŒä¸ªShellä»»åŠ¡æ¥ä¿®å¤æ–‡ä»¶æƒé™ï¼š

**ä»»åŠ¡åç§°**: `fix_permissions`
**ä»»åŠ¡ç±»å‹**: Shell
**ä¾èµ–ä»»åŠ¡**: `unzip_deploy_package`
**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash
chmod +x /dolphinscheduler/default/resources/bigdata_tag_system/main.py
chmod -R 755 /dolphinscheduler/default/resources/bigdata_tag_system/
echo "âœ… æ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"
```

### 4. åˆ›å»ºShellä»»åŠ¡ - å®‰è£…ä¾èµ–ï¼ˆå¯é€‰ï¼‰
åˆ›å»ºç¬¬ä¸‰ä¸ªShellä»»åŠ¡æ¥å®‰è£…Pythonä¾èµ–ï¼š

**ä»»åŠ¡åç§°**: `install_dependencies`
**ä»»åŠ¡ç±»å‹**: Shell
**ä¾èµ–ä»»åŠ¡**: `fix_permissions`
**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/bigdata_tag_system
pip3 install -r requirements.txt --break-system-packages
echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
```

### 5. åˆ›å»ºSparkä»»åŠ¡ - ç³»ç»Ÿå¥åº·æ£€æŸ¥
åˆ›å»ºç¬¬å››ä¸ªSparkä»»åŠ¡è¿›è¡Œå¥åº·æ£€æŸ¥ï¼š

**ä»»åŠ¡åç§°**: `health_check`
**ä»»åŠ¡ç±»å‹**: Spark
**ä¾èµ–ä»»åŠ¡**: `install_dependencies`ï¼ˆæˆ–è€…`fix_permissions`å¦‚æœè·³è¿‡ä¾èµ–å®‰è£…ï¼‰
**ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
**ä¸»ç¨‹åºå‚æ•°**: `--mode health`
**Driverå†…å­˜**: 1g
**Executoræ•°é‡**: 1

### 6. åˆ›å»ºå®Œæ•´å·¥ä½œæµ - æ ‡ç­¾ç³»ç»Ÿéƒ¨ç½²æµ‹è¯•

åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å·¥ä½œæµæ¥éªŒè¯éƒ¨ç½²ï¼ŒåŒ…å«æŒ‰é¡ºåºæ‰§è¡Œçš„ä»»åŠ¡ï¼š

#### ğŸ“‹ å·¥ä½œæµåç§°ï¼š`tag_system_deploy_test`

**ä»»åŠ¡A: è§£å‹éƒ¨ç½²åŒ…** ğŸ“¦
- **ä»»åŠ¡åç§°**: `unzip_deploy_package`
- **ä»»åŠ¡ç±»å‹**: Shell
- **ä¾èµ–**: æ— ï¼ˆèµ·å§‹ä»»åŠ¡ï¼‰
- **è„šæœ¬**: 
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/
unzip -o tag_system_dolphin.zip -d bigdata_tag_system/
echo "âœ… éƒ¨ç½²åŒ…è§£å‹å®Œæˆåˆ°: /dolphinscheduler/default/resources/bigdata_tag_system/"
ls -la bigdata_tag_system/main.py bigdata_tag_system/src/ bigdata_tag_system/requirements.txt
```

**ä»»åŠ¡B: å®‰è£…ä¾èµ–** ğŸ”§ (å¯é€‰)
- **ä»»åŠ¡åç§°**: `install_dependencies`
- **ä»»åŠ¡ç±»å‹**: Shell
- **ä¾èµ–**: `unzip_deploy_package`
- **è„šæœ¬**: 
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/bigdata_tag_system
pip3 install -r requirements.txt --break-system-packages
echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
```

**ä»»åŠ¡C: ç³»ç»Ÿå¥åº·æ£€æŸ¥** âš¡
- **ä»»åŠ¡åç§°**: `health_check`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `install_dependencies`ï¼ˆæˆ–`unzip_deploy_package`å¦‚æœè·³è¿‡ä¾èµ–å®‰è£…ï¼‰
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode health`
- **Driverå†…å­˜**: 1g, **Executoræ•°é‡**: 1
- **ä½œç”¨**: éªŒè¯Hiveå’ŒMySQLè¿æ¥

**ä»»åŠ¡D: ç”Ÿæˆæµ‹è¯•æ•°æ®** ğŸ“Š
- **ä»»åŠ¡åç§°**: `generate_test_data`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `health_check`
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode generate-test-data --dt 2025-01-20`
- **é€‰é¡¹å‚æ•°**: `--jars /dolphinscheduler/default/resources/mysql-connector-j-8.0.33.jar`
- **Driverå†…å­˜**: 2g, **Executoræ•°é‡**: 3, **Executorå†…å­˜**: 4g
- **ä½œç”¨**: ç”Ÿæˆ1000ä¸ªç”¨æˆ·çš„æµ‹è¯•æ•°æ®åˆ°Hiveè¡¨

**ä»»åŠ¡E: æŒ‡å®šæ ‡ç­¾è®¡ç®—** ğŸ·ï¸
- **ä»»åŠ¡åç§°**: `compute_specific_tags`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `generate_test_data`
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode task-tags --tag-ids 1,2,3`
- **Driverå†…å­˜**: 4g, **Executoræ•°é‡**: 5, **Executorå†…å­˜**: 8g
- **ä½œç”¨**: è®¡ç®—æŒ‡å®šæ ‡ç­¾å¹¶å†™å…¥MySQL

### 7. é€šç”¨Sparké…ç½®
**æ‰€æœ‰ä»»åŠ¡çš„åŸºç¡€é…ç½®**:
- Driveræ ¸å¿ƒæ•°: 2
- Executoræ ¸å¿ƒæ•°: 2
- YARNé˜Ÿåˆ—: default
- å¤±è´¥é‡è¯•æ¬¡æ•°: 2
- ä»»åŠ¡è¶…æ—¶: 30åˆ†é’Ÿ

## ğŸ¯ æ”¯æŒçš„æ‰§è¡Œæ¨¡å¼

### å¥åº·æ£€æŸ¥æ¨¡å¼
```bash
--mode health
```
éªŒè¯Hiveå’ŒMySQLè¿æ¥

### æµ‹è¯•æ•°æ®ç”Ÿæˆ
```bash
--mode generate-test-data --dt 2025-01-20
```
ç”Ÿæˆæµ‹è¯•æ•°æ®åˆ°Hiveè¡¨

### å…¨é‡æ ‡ç­¾è®¡ç®—
```bash
--mode task-all
```
è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰æ ‡ç­¾

### æŒ‡å®šæ ‡ç­¾è®¡ç®—
```bash
--mode task-tags --tag-ids 1,2,3
```
è®¡ç®—æŒ‡å®šæ ‡ç­¾IDçš„æ ‡ç­¾

### ä»»åŠ¡åˆ—è¡¨æŸ¥çœ‹
```bash
--mode list-tasks
```
æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ ‡ç­¾ä»»åŠ¡

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å‚æ•°åŒ–å·¥ä½œæµ
åœ¨å·¥ä½œæµä¸­ä½¿ç”¨å…¨å±€å‚æ•°:
- `tag_ids`: æ ‡ç­¾IDåˆ—è¡¨
- `data_date`: æ•°æ®æ—¥æœŸ
- `mode`: æ‰§è¡Œæ¨¡å¼

### 2. ä¾èµ–ç®¡ç†
**é€šå¸¸æƒ…å†µ**ï¼šæ— éœ€é¢å¤–å®‰è£…Pythonä¾èµ–ï¼Œä½¿ç”¨é›†ç¾¤é¢„è£…çš„PySparkç¯å¢ƒ

**ç‰¹æ®Šæƒ…å†µ**ï¼šå¦‚æœé›†ç¾¤ç¯å¢ƒç¼ºå°‘pymysqlï¼Œå¯åˆ›å»ºShellä»»åŠ¡ï¼š
```bash
#!/bin/bash
pip3 install pymysql
echo "âœ… å®‰è£…MySQLè¿æ¥å™¨å®Œæˆ"
```

**éªŒè¯ä¾èµ–**ï¼šè¿è¡Œå¥åº·æ£€æŸ¥ä»»åŠ¡éªŒè¯æ‰€æœ‰ä¾èµ–æ˜¯å¦æ­£å¸¸

### 3. é”™è¯¯å¤„ç†
- è®¾ç½®ä»»åŠ¡å¤±è´¥é‡è¯•æ¬¡æ•°: 2
- è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´: 30åˆ†é’Ÿ
- é…ç½®å‘Šè­¦é€šçŸ¥

### 4. ç›‘æ§å»ºè®®
- å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥ä»»åŠ¡
- ç›‘æ§MySQLæ ‡ç­¾æ•°æ®å¢é•¿
- æŸ¥çœ‹Spark UIèµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ”§ æ•…éšœæ’é™¤

### MySQLè¿æ¥é—®é¢˜
- æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
- éªŒè¯ç”¨æˆ·åå¯†ç 
- ç¡®è®¤æ•°æ®åº“æƒé™

### Hiveè¡¨è®¿é—®é—®é¢˜
- éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥åˆ†åŒºæ•°æ®
- ç¡®è®¤æƒé™é…ç½®

### æ€§èƒ½ä¼˜åŒ–
- æ ¹æ®æ•°æ®é‡è°ƒæ•´Executoré…ç½®
- è€ƒè™‘å¢åŠ å¹¶è¡Œåº¦
- ä¼˜åŒ–SQLæŸ¥è¯¢é€»è¾‘

## ğŸ·ï¸ å…³é”®é…ç½®

### MySQLè¿æ¥ï¼ˆç»Ÿä¸€é…ç½®ï¼‰
ç³»ç»Ÿä½¿ç”¨src.config.base.MySQLConfigç»Ÿä¸€é…ç½®ï¼š
- **ä¸»æœº**: cex-mysql-test.c5mgk4qm8m2z.ap-southeast-1.rds.amazonaws.com
- **ç«¯å£**: 3358
- **æ•°æ®åº“**: biz_statistics

### Hiveè¡¨ç›´æ¥è¯»å–
åŸºäºDirectHiveReaderå®ç°ï¼Œæ”¯æŒï¼š
- ä½¿ç”¨ `MSCK REPAIR TABLE` è‡ªåŠ¨å‘ç°åˆ†åŒº
- ç›´æ¥é€šè¿‡ `spark.table()` è¯»å–è¡¨æ•°æ®
- æ”¯æŒåˆ†åŒºè¿‡æ»¤ï¼š`spark.table("table").where("dt = 'xxx'")`

### æ ‡ç­¾æ•°æ®æ¨¡å‹
- **ä¸€ä¸ªç”¨æˆ·ä¸€æ¡è®°å½•**è®¾è®¡
- æ ‡ç­¾IDå­˜å‚¨ä¸ºJSONæ•°ç»„: `[1,2,3,5]`
- æ”¯æŒæ ‡ç­¾åˆå¹¶ï¼šæ–°æ ‡ç­¾ä¸MySQLç°æœ‰æ ‡ç­¾è‡ªåŠ¨åˆå¹¶
- æ—¶é—´æˆ³è¿½è¸ªï¼šcreated_timeï¼ˆæ°¸ä¸å˜ï¼‰ï¼Œupdated_timeï¼ˆæ ‡ç­¾å˜åŒ–æ—¶æ›´æ–°ï¼‰