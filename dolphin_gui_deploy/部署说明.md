# ğŸ¬ æµ·è±šè°ƒåº¦å™¨æ ‡ç­¾ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“¦ éƒ¨ç½²åŒ…å†…å®¹
- `main.py` - ä¸»ç¨‹åºå…¥å£ï¼ˆç›´æ¥æ¥è‡ª src/tag_engine/main.pyï¼‰
- `src/` - é¡¹ç›®æºç ï¼ˆPySpark DSL + UDFæ¶æ„ï¼‰  
- `generate_test_data.py` - æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
- `create_test_tables.sql` - æµ‹è¯•è¡¨åˆ›å»ºSQL
- `requirements.txt` - Pythonä¾èµ–

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ éƒ¨ç½²åŒ…
1. ç™»å½•æµ·è±šè°ƒåº¦å™¨Webç•Œé¢
2. è¿›å…¥ **èµ„æºä¸­å¿ƒ** â†’ **æ–‡ä»¶ç®¡ç†**
3. ä¸Šä¼  `tag_system_dolphin.zip`

### 2. è§£å‹éƒ¨ç½²åŒ…
**ä»»åŠ¡åç§°**: `unzip_deploy_package`  
**ä»»åŠ¡ç±»å‹**: Shell  
**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/
unzip -o bigdata_tag_system.zip -d bigdata_tag_system/
chmod +x /dolphinscheduler/default/resources/bigdata_tag_system/main.py
chmod -R 755 /dolphinscheduler/default/resources/bigdata_tag_system/
echo "âœ… éƒ¨ç½²åŒ…è§£å‹å®Œæˆåˆ°: /dolphinscheduler/default/resources/bigdata_tag_system/"
ls -la bigdata_tag_system/main.py bigdata_tag_system/src/
```

### 3. å®‰è£…Pythonä¾èµ–
**ä»»åŠ¡åç§°**: `install_dependencies`  
**ä»»åŠ¡ç±»å‹**: Shell  
**ä¾èµ–**: `unzip_deploy_package`
**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash
cd /dolphinscheduler/default/resources/bigdata_tag_system/

# æ£€æŸ¥Pythonç¯å¢ƒ
python3 --version
pip3 --version

# å®‰è£…æ ¸å¿ƒä¾èµ–
echo "ğŸ“¦ å¼€å§‹å®‰è£…Pythonä¾èµ–åŒ…..."
pip3 install --user -r requirements.txt

# éªŒè¯å…³é”®ä¾èµ–
echo "ğŸ” éªŒè¯æ ¸å¿ƒä¾èµ–å®‰è£…..."
python3 -c "import pyspark; print(f'âœ… PySparkç‰ˆæœ¬: {pyspark.__version__}')"
python3 -c "import pymysql; print('âœ… PyMySQLå®‰è£…æˆåŠŸ')"
python3 -c "import pandas; print(f'âœ… Pandasç‰ˆæœ¬: {pandas.__version__}')"

echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
```

### 4. åˆ›å»ºæ ‡ç­¾è®¡ç®—å·¥ä½œæµ
åˆ›å»ºå·¥ä½œæµåç§°ï¼š`æ ‡ç­¾ç³»ç»Ÿå®Œæ•´æµç¨‹`

## ğŸ“‹ å·¥ä½œæµä»»åŠ¡é…ç½®

### ä»»åŠ¡A: ç”Ÿæˆæµ‹è¯•æ•°æ® ğŸ§ª
- **ä»»åŠ¡åç§°**: `generate_test_data`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `install_dependencies`
- **éƒ¨ç½²æ¨¡å¼**: local
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode generate-test-data`
- **Driverå†…å­˜**: 1g
- **Executoræ•°é‡**: 1
- **ä½œç”¨**: ç”Ÿæˆæµ‹è¯•ç”¨æˆ·æ•°æ®åˆ°Hiveè¡¨

### ä»»åŠ¡B: ç³»ç»Ÿå¥åº·æ£€æŸ¥ âš¡
- **ä»»åŠ¡åç§°**: `health_check`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `generate_test_data`
- **éƒ¨ç½²æ¨¡å¼**: local
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode health`
- **Driverå†…å­˜**: 1g
- **Executoræ•°é‡**: 1
- **ä½œç”¨**: éªŒè¯MySQLã€Hiveè¿æ¥å’ŒUDFå‡½æ•°

### ä»»åŠ¡C: å…¨é‡æ ‡ç­¾è®¡ç®— ğŸ·ï¸
- **ä»»åŠ¡åç§°**: `full_compute_tags`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `health_check`
- **éƒ¨ç½²æ¨¡å¼**: client
- **ä¸»ç¨‹åº**: `bigdata_tag_system/src/tag_engine/main.py`
- **èµ„æºæ–‡ä»¶**: 
  - âœ… é€‰æ‹© `bigdata_tag_system` (æ•´ä¸ªé¡¹ç›®ç›®å½•)
- **ä¸»ç¨‹åºå‚æ•°**: `--mode task-all`
- **å…¶ä»–å‚æ•°**: `--jars s3://exchanges-flink-test/dolphinscheduler/default/resources/connectors/mysql-connector-j-8.0.33.jar`
- **Driverå†…å­˜**: 2g
- **Executoræ•°é‡**: 2
- **Executorå†…å­˜**: 4g
- **ä½œç”¨**: è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰æ ‡ç­¾å¹¶å†™å…¥MySQL

### ä»»åŠ¡D: æŒ‡å®šæ ‡ç­¾è®¡ç®— ğŸ¯
- **ä»»åŠ¡åç§°**: `specific_compute_tags`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `full_compute_tags`
- **éƒ¨ç½²æ¨¡å¼**: client
- **ä¸»ç¨‹åº**: `bigdata_tag_system/src/tag_engine/main.py`
- **èµ„æºæ–‡ä»¶**: 
  - âœ… é€‰æ‹© `bigdata_tag_system` (æ•´ä¸ªé¡¹ç›®ç›®å½•)
- **ä¸»ç¨‹åºå‚æ•°**: `--mode task-tags --tag-ids 1,2,3,5,10`
- **å…¶ä»–å‚æ•°**: `--jars s3://exchanges-flink-test/dolphinscheduler/default/resources/connectors/mysql-connector-j-8.0.33.jar`
- **Driverå†…å­˜**: 2g
- **Executoræ•°é‡**: 2
- **Executorå†…å­˜**: 4g
- **ä½œç”¨**: è®¡ç®—æŒ‡å®šæ ‡ç­¾å¹¶éªŒè¯æ ‡ç­¾åˆå¹¶é€»è¾‘

### ä»»åŠ¡E: åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾ ğŸ“‹
- **ä»»åŠ¡åç§°**: `list_all_tags`
- **ä»»åŠ¡ç±»å‹**: Spark
- **ä¾èµ–**: `specific_compute_tags`
- **éƒ¨ç½²æ¨¡å¼**: local
- **ä¸»ç¨‹åº**: `/dolphinscheduler/default/resources/bigdata_tag_system/main.py`
- **ä¸»ç¨‹åºå‚æ•°**: `--mode list-tasks`
- **Driverå†…å­˜**: 1g
- **Executoræ•°é‡**: 1
- **ä½œç”¨**: åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ ‡ç­¾ä»»åŠ¡

## ğŸ¯ æ”¯æŒçš„æ‰§è¡Œæ¨¡å¼

### ç”Ÿæˆæµ‹è¯•æ•°æ®
```bash
--mode generate-test-data
```
ç”Ÿæˆ1000æ¡ç”¨æˆ·æµ‹è¯•æ•°æ®åˆ°Hiveè¡¨

### å¥åº·æ£€æŸ¥
```bash
--mode health
```
éªŒè¯MySQLã€Hiveè¿æ¥å’ŒUDFå‡½æ•°

### å…¨é‡æ ‡ç­¾è®¡ç®—
```bash
--mode task-all
```
è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰50ä¸ªæ ‡ç­¾

### æŒ‡å®šæ ‡ç­¾è®¡ç®—
```bash
--mode task-tags --tag-ids 1,2,3,5,10
```
è®¡ç®—æŒ‡å®šç”¨æˆ·çš„æŒ‡å®šæ ‡ç­¾

### åˆ—å‡ºæ ‡ç­¾ä»»åŠ¡
```bash
--mode list-tasks
```
æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„50ä¸ªæ ‡ç­¾å®šä¹‰

## âš™ï¸ Sparkä»»åŠ¡é€šç”¨é…ç½®

### æœ¬åœ°æ¨¡å¼é…ç½®ï¼ˆæ¨èï¼‰
- **éƒ¨ç½²æ¨¡å¼**: local
- **Driveræ ¸å¿ƒæ•°**: 1
- **Driverå†…å­˜**: 1g-2g
- **Executoræ•°é‡**: 1-2
- **Executoræ ¸å¿ƒæ•°**: 2
- **Executorå†…å­˜**: 2g-4g
- **å¤±è´¥é‡è¯•æ¬¡æ•°**: 2
- **ä»»åŠ¡è¶…æ—¶**: 30åˆ†é’Ÿ

### é›†ç¾¤æ¨¡å¼é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **éƒ¨ç½²æ¨¡å¼**: cluster
- **Driveræ ¸å¿ƒæ•°**: 2
- **Driverå†…å­˜**: 4g
- **Executoræ•°é‡**: 5
- **Executoræ ¸å¿ƒæ•°**: 2
- **Executorå†…å­˜**: 8g
- **YARNé˜Ÿåˆ—**: default

## ğŸ”§ MySQLè¿æ¥é…ç½®

ç³»ç»Ÿé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®MySQLè¿æ¥ï¼š
```bash
export MYSQL_HOST="cex-mysql-test.c5mgk4qm8m2z.ap-southeast-1.rds.amazonaws.com"
export MYSQL_PORT="3358"
export MYSQL_DATABASE="biz_statistics"
export MYSQL_USER="root"
export MYSQL_PASSWORD="ayjUzzH8b7gcQYRh"
```

### JDBCè¿æ¥å‚æ•°
- **å­—ç¬¦ç¼–ç **: ä½¿ç”¨ `connectionCollation=utf8mb4_unicode_ci`
- **SSL**: ç¦ç”¨ `useSSL=false`
- **æ—¶åŒº**: è®¾ç½® `serverTimezone=UTC`

## ğŸ“Š æ•°æ®æ¨¡å‹è¯´æ˜

### æ ‡ç­¾æ•°æ®ç»“æ„
- **50ä¸ªæ ‡ç­¾å®šä¹‰**ï¼šè¦†ç›–æ•°å€¼ã€å­—ç¬¦ä¸²ã€æ—¥æœŸã€å¸ƒå°”ã€æšä¸¾ã€åˆ—è¡¨ç­‰æ‰€æœ‰æ•°æ®ç±»å‹
- **10ä¸ªæ ‡ç­¾åˆ†ç±»**ï¼šç”¨æˆ·ä»·å€¼ã€è¡Œä¸ºç‰¹å¾ã€é£é™©ç­‰çº§ã€ç”Ÿå‘½å‘¨æœŸç­‰
- **ç”¨æˆ·æ ‡ç­¾å­˜å‚¨**ï¼šä¸€ä¸ªç”¨æˆ·ä¸€æ¡è®°å½•ï¼Œæ ‡ç­¾IDå­˜å‚¨ä¸ºJSONæ•°ç»„

### æµ‹è¯•æ•°æ®è§„æ¨¡
- **ç”¨æˆ·æ•°æ®**: 1000ä¸ªæµ‹è¯•ç”¨æˆ·
- **æ ‡ç­¾è§„åˆ™**: 50æ¡å®Œæ•´è§„åˆ™
- **æ•°æ®è¡¨**: user_basic_info, user_asset_summary, user_activity_summary

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡éƒ¨ç½²
1. å…ˆè¿è¡Œ `install_dependencies` å®‰è£…Pythonä¾èµ–
2. ç„¶åè¿è¡Œ `generate_test_data` ç”Ÿæˆæµ‹è¯•æ•°æ®
3. å†è¿è¡Œ `health_check` éªŒè¯ç¯å¢ƒ
4. æœ€åè¿›è¡Œæ ‡ç­¾è®¡ç®—ä»»åŠ¡

### 2. å‚æ•°åŒ–é…ç½®
å·¥ä½œæµä¸­å¯ä½¿ç”¨å…¨å±€å‚æ•°ï¼š
- `tag_ids`: æŒ‡å®šæ ‡ç­¾IDåˆ—è¡¨
- `mode`: æ‰§è¡Œæ¨¡å¼é€‰æ‹©

### 3. ç›‘æ§å»ºè®®
- æŸ¥çœ‹Spark UIç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µï¼šhttp://driver:4040
- ç›‘æ§MySQLæ ‡ç­¾æ•°æ®å¢é•¿
- å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥éªŒè¯ç³»ç»ŸçŠ¶æ€

## ğŸš¨ æ•…éšœæ’é™¤

### MySQLè¿æ¥é—®é¢˜
```
âŒ java.sql.SQLException: Unsupported character encoding 'utf8mb4'
```
**è§£å†³**: å·²ä¿®å¤JDBCè¿æ¥å‚æ•°ä¸º `connectionCollation=utf8mb4_unicode_ci`

### Pythonä¾èµ–é—®é¢˜
```
âŒ ModuleNotFoundError: No module named 'pyspark'
```
**è§£å†³**: ç¡®ä¿å…ˆè¿è¡Œ `install_dependencies` ä»»åŠ¡å®‰è£…æ‰€æœ‰ä¾èµ–

### Hiveè¡¨è®¿é—®é—®é¢˜
- ç¡®ä¿æµ‹è¯•æ•°æ®å·²ç”Ÿæˆï¼šå…ˆè¿è¡Œ `generate_test_data` ä»»åŠ¡
- æ£€æŸ¥è¡¨åˆ†åŒºï¼šç¡®è®¤ `dt` åˆ†åŒºæ•°æ®å­˜åœ¨

### æ€§èƒ½è°ƒä¼˜
- **å°æ•°æ®é‡**: ä½¿ç”¨localæ¨¡å¼ï¼Œ1-2ä¸ªExecutor
- **å¤§æ•°æ®é‡**: ä½¿ç”¨clusteræ¨¡å¼ï¼Œå¢åŠ Executoræ•°é‡å’Œå†…å­˜

## ğŸ“ˆ æ‰©å±•é…ç½®

### ç”Ÿäº§ç¯å¢ƒå»ºè®®
- ä½¿ç”¨clusteréƒ¨ç½²æ¨¡å¼
- å¢åŠ Driverå’ŒExecutorå†…å­˜é…ç½®
- é…ç½®YARNèµ„æºé˜Ÿåˆ—
- è®¾ç½®åˆé€‚çš„å¹¶è¡Œåº¦å‚æ•°

### è‡ªå®šä¹‰æ ‡ç­¾
- ä¿®æ”¹ `environments/local/init_database.sql` æ·»åŠ æ–°æ ‡ç­¾
- é‡æ–°åˆå§‹åŒ–MySQLæ•°æ®åº“
- è¿è¡Œ `list-tasks` éªŒè¯æ–°æ ‡ç­¾åŠ è½½